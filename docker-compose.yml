x-omnibus-base: &omnibus-base
  build:
    context: .
    dockerfile: Dockerfile
    target: runtime-omnibus
  working_dir: /app/processes/omnibus
  environment:
    RUST_LOG: ${RUST_LOG:-info}
  user: "${OMNIBUS_UID:-0}:${OMNIBUS_GID:-0}"
  restart: unless-stopped

x-midnight-indexer-base: &midnight-indexer-base
  build:
    context: .
    dockerfile: Dockerfile
    target: runtime-midnight-indexer
  working_dir: /app/processes/midnight_indexer
  environment:
    RUST_LOG: ${RUST_LOG:-info}
  user: "${MIDNIGHT_UID:-0}:${MIDNIGHT_GID:-0}"
  restart: unless-stopped

services:
  omnibus-preview:
    <<: *omnibus-base
    container_name: omnibus-preview
    command: ["--config", "omnibus-preview.toml"]
    ports:
      - "${OMNIBUS_PREVIEW_REST_PORT:-4340}:4340"
      - "${OMNIBUS_PREVIEW_MCP_PORT:-4341}:4341"
    volumes:
      - ${MITHRIL_DOWNLOADS_DIR_PREVIEW:-omnibus_preview_downloads}:/app/modules/mithril_snapshot_fetcher/downloads
      - ${SNAPSHOT_DATA_DIR_PREVIEW:-omnibus_preview_snapshot_data}:/app/modules/snapshot_bootstrapper/data
      - ${ADDRESS_STATE_DB_DIR_PREVIEW:-omnibus_preview_address_state_db}:/app/modules/address_state/db
      - ${HISTORICAL_ACCOUNTS_DB_DIR_PREVIEW:-omnibus_preview_historical_accounts_state_db}:/app/modules/historical_accounts_state/db
      - omnibus_preview_spdd:/app/processes/omnibus/fjall-spdd

  omnibus-mainnet:
    <<: *omnibus-base
    container_name: omnibus-mainnet
    command: ["--config", "omnibus.toml"]
    ports:
      - "${OMNIBUS_MAINNET_REST_PORT:-5340}:4340"
      - "${OMNIBUS_MAINNET_MCP_PORT:-5341}:4341"
    volumes:
      - ${MITHRIL_DOWNLOADS_DIR_MAINNET:-omnibus_mainnet_downloads}:/app/modules/mithril_snapshot_fetcher/downloads
      - ${SNAPSHOT_DATA_DIR_MAINNET:-omnibus_mainnet_snapshot_data}:/app/modules/snapshot_bootstrapper/data
      - ${ADDRESS_STATE_DB_DIR_MAINNET:-omnibus_mainnet_address_state_db}:/app/modules/address_state/db
      - ${HISTORICAL_ACCOUNTS_DB_DIR_MAINNET:-omnibus_mainnet_historical_accounts_state_db}:/app/modules/historical_accounts_state/db
      - omnibus_mainnet_spdd:/app/processes/omnibus/fjall-spdd

  midnight-indexer-preview:
    <<: *midnight-indexer-base
    container_name: midnight-indexer-preview
    command: ["--config", "config.preview.toml"]
    volumes:
      - ${MITHRIL_DOWNLOADS_DIR_PREVIEW:-midnight_indexer_preview_downloads}:/app/modules/mithril_snapshot_fetcher/downloads
      - ${SNAPSHOT_DATA_DIR_PREVIEW:-midnight_indexer_preview_snapshot_data}:/app/modules/snapshot_bootstrapper/data
      - ${CHAIN_STORE_DB_DIR_PREVIEW:-midnight_indexer_preview_chain_store_db}:/app/processes/midnight_indexer/fjall-blocks-preview
      - ${SPDD_DB_DIR_PREVIEW:-midnight_indexer_preview_spdd_db}:/app/processes/midnight_indexer/fjall-spdd

  midnight-indexer-mainnet:
    <<: *midnight-indexer-base
    container_name: midnight-indexer-mainnet
    command: ["--config", "config.mainnet.toml"]
    volumes:
      - ${MITHRIL_DOWNLOADS_DIR_MAINNET:-midnight_indexer_mainnet_downloads}:/app/modules/mithril_snapshot_fetcher/downloads
      - ${SNAPSHOT_DATA_DIR_MAINNET:-midnight_indexer_mainnet_snapshot_data}:/app/modules/snapshot_bootstrapper/data
      - ${CHAIN_STORE_DB_DIR_MAINNET:-midnight_indexer_mainnet_chain_store_db}:/app/processes/midnight_indexer/fjall-blocks-mainnet
      - ${SPDD_DB_DIR_MAINNET:-midnight_indexer_mainnet_spdd_db}:/app/processes/midnight_indexer/fjall-spdd

volumes:
  omnibus_preview_spdd:
  omnibus_preview_downloads:
  omnibus_preview_snapshot_data:
  omnibus_preview_address_state_db:
  omnibus_preview_historical_accounts_state_db:
  omnibus_mainnet_spdd:
  omnibus_mainnet_downloads:
  omnibus_mainnet_snapshot_data:
  omnibus_mainnet_address_state_db:
  omnibus_mainnet_historical_accounts_state_db:
  midnight_indexer_preview_downloads:
  midnight_indexer_preview_snapshot_data:
  midnight_indexer_preview_chain_store_db:
  midnight_indexer_preview_spdd_db:
  midnight_indexer_mainnet_downloads:
  midnight_indexer_mainnet_snapshot_data:
  midnight_indexer_mainnet_chain_store_db:
  midnight_indexer_mainnet_spdd_db:
