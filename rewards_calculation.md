11 Rewards and the Epoch BoundaryThis chapter introduces the epoch boundary transition system and the related reward calculation.The transition system is defined in Section 11.8, and involves taking stake distributionsnapshots (Sections 11.4 and 11.5), retiring stake pools (Section 11.6), and performing protocolupdates (Section 11.7). The reward calculation, defined in Sections 11.9 and 11.10, distributesthe leader election rewards.11.1 Overview of the Reward CalculationThe rewards for a given epoch ei involve the two epochs surrounding it. In particular, thestake distribution will come from the previous epoch and the rewards will be calculated in thefollowing epoch. More concretely:(A) A stake distribution snapshot is taken at the begining of epoch ei−1.(B) The randomness for leader election is fixed during epoch ei−1(C) Epoch ei begins.(D) Epoch ei ends. A snapshot is taken of the stake pool performance during epoch ei. Asnapshot is also taken of the fee pot.(E) The snapshots from (D) are stable and the reward calculation can begin.(F) The reward calculation is finished and an update to the ledger state is ready to be applied.(G) Rewards are given out.ei−1 ei ei+1A B C D E F GWe must therefore store the last three stake distributions. The mnemonic “mark, set, go”will be used to keep track of the snapshots, where the label “mark” refers to the most recentsnapshot, and “go” refers to the snapshot that is ready to be used in the reward calculation. Inthe above diagram, the snapshot taken at (A) is labeled “mark” during epoch ei−1, “set” duringepoch ei and “go” during epoch ei+1. At (G) the snapshot taken at (A) is no longer needed andwill be discarded.The two main transition systems in this section are:• The transition system named EPOCH, which is defined in Section 11.8, covers whathappens at the epoch boundary, such as at (A), (C), (D) and (G).• The transition named RUPD, which is defined in Section 12.6, covers the reward calculationthat happens between (E) and (F).Between time D and E we are concerned with chain growth and stability. Therefore thisduration can be stated as 2k blocks (to state it in slots requires details about the particularversion of the Ouroboros protocol). The duration between F and G is also 2k blocks.Between E and F a single honest block is enough to ensure a random nonce.NOTEShelley Ledger: Formal Cardano Ledger Spec. (SL-D5 v.1.0, 2019/10/08) 4811.2 Example Illustration of the Reward Cyclee1 e2 e3 e4Alicedelegate to BobBobinitial poolregistrationre-registrationAlice’s opportunityto re-delegatebefore Bob’s newparametersmarksetgomarksetgoBob registers his stake pool in epoch e1. Alice delegates to Bob’s stake pool in epoch e1.Just before the end of epoch e1, Bob submits a stake pool re-registration, changing his poolparameters. The change in parameters is not immediate, as shown by the curved arrow aroundthe epoch boundary.A snapshot is taken on the e1/e2 boundary. It is labeled “mark” initially. This snapshotincludes Alice’s delegation to Bob’s pool, and Bob’s pool parameters and listed in the initialpool registration certificate.If Alice changes her delegation choice any time during epoch e2, she will never be effectedby Bob’s change of parameters.A new snapshot is taken on the e2/e3 boundary. The previous (darker blue) snapshot is nowlabeled “set”, and the new one labeled “mark”. The “set” snapshot is used for leader election inepoch e3.On the e3/e4 boundary, the darker blue snapshot is labeled “go” and the lighter blue snapshotis labeled “set”. Bob’s stake pool performance during epoch e3 (he produced 4 blocks) will beused with the darker blue snapshot for the rewards which will be handed out at the beginningof epoch e5.11.3 Helper Functions and Accounting FieldsFigure 34 defines four helper functions needed throughout the rest of the section.• The function obligation calculates the the minimal amount of coin needed to pay out alldeposit refunds.• The function poolStake filters the stake distribution to one stake pool.The Figure 35 lists the accounting fields, denoted by Acnt, which will be used throughoutthis section. It consists of:• The value treasury tracks the amount of coin currently stored in the treasury. Initially therewill be no way to remove these funds.• The value reserves tracks the amount of coin currently stored in the reserves. This pot isused to pay rewards.More will be said about the general accounting system in Section 11.10.Shelley Ledger: Formal Cardano Ledger Spec. (SL-D5 v.1.0, 2019/10/08) 49Total possible refundsobligation ∈ PParams → (Credentialstake 7 → Coin) → (KeyHashpool 7 → PoolParam) → Coinobligation pp rewards poolParams =(keyDeposit pp) · |rewards| + (poolDeposit pp) · |poolParams|Filter Stake to one PoolpoolStake ∈ KeyHashpool → (KeyHashstake 7 → KeyHashpool ) → Stake → StakepoolStake hk delegs stake = dom (delegs  {hk})  stakeFigure 34: Helper Functions used in Rewards and Epoch BoundaryAccounting FieldsAcnt = treasury ∈ Coin treasury potreserves ∈ Coin reserve potFigure 35: Accounting fields11.4 Stake Distribution CalculationThis section defines the stake distribution calculations. Figure 36 introduces three new derivedtypes:• BlocksMade represents the number of blocks each stake pool produced during an epoch.• Stake represents the amount of stake (in Coin) controlled by each stake pool.Derived typesblocks ∈ BlocksMade = KeyHashpool 7 → N blocks made by stake poolsstake ∈ Stake = Credential 7 → Coin stakeFigure 36: Epoch definitionsThe stake distribution calculation is given in Figure 37.• aggregate+ takes a relation on A × B, where B is any monoid (B, +, e) and returns a mapfrom each a ∈ A to the “sum” (using the monoidal + operation) of all b ∈ B such that(a, b) ∈ A × B.• stakeDistr uses the aggregate+ function and several relations to compute the stake distri-bution, mapping each hashkey to the total coin under its control. Keys that are not bothregistered and delegated are filtered out. The relation passed to aggregate+ is made up of:– stakeCredb−1, relating credentials to (base) addresses– (addrPtr ◦ ptr)−1, relating credentials to (pointer) addresses– range utxo, relating addresses to coins– stakeCredr−1 ◦ rewards, relating (reward) addresses to coinsThe notation for relations is explained in Section 2.
